package compiler.syntax;

// Declaracion de importaciones 
//(No modificar las proporcionadas. Se pueden agregar mas)

import java_cup.runtime.Symbol;
import java.util.*;

import es.uned.lsi.compiler.lexical.*;
import es.uned.lsi.compiler.code.*;
import es.uned.lsi.compiler.intermediate.*;
import es.uned.lsi.compiler.semantic.*;
import es.uned.lsi.compiler.semantic.symbol.*;
import es.uned.lsi.compiler.semantic.type.*;
import es.uned.lsi.compiler.syntax.*;

import compiler.CompilerContext;
import compiler.lexical.*;
import compiler.syntax.nonTerminal.*;

import compiler.semantic.symbol.*;
import compiler.semantic.type.*;
import compiler.intermediate.*;
import compiler.code.*;

// Declaracion del codigo de usuario

action code {:
	
	SyntaxErrorManager   syntaxErrorManager   = CompilerContext.getSyntaxErrorManager();
	SemanticErrorManager semanticErrorManager = CompilerContext.getSemanticErrorManager ();
	ScopeManagerIF       scopeManager         = CompilerContext.getScopeManager ();
	FinalCodeFactoryIF   finalCodeFactory     = CompilerContext.getFinalCodeFactory ();

:}	

parser code {:
	SyntaxErrorManager syntaxErrorManager = CompilerContext.getSyntaxErrorManager();
	
	public void syntax_error(Symbol symbol)
	{ 	    		    
	    Token token = (Token) symbol.value;
	    syntaxErrorManager.syntaxError ("Error sintactico", token);	    
	}
		
	public void unrecovered_syntax_error(java_cup.runtime.Symbol symbol)
	{	
	    Token token = (Token) symbol.value;
	    syntaxErrorManager.syntaxFatalError ("Error fatal", token);
	}
:}

// Declaracion de terminales (Ejemplo)

terminal Token MAS;
terminal Token MENOS;
terminal Token POR;
terminal Token PUNTO;
terminal Token COMA;
terminal Token PUNTO_Y_COMA;
terminal Token DOS_PUNTOS;
terminal Token IGUAL;
terminal Token ASIGNACION;
terminal Token RANGO;
terminal Token MAYOR;
terminal Token DISTINTO;
terminal Token ABRE_PARENTESIS;
terminal Token CIERRA_PARENTESIS;
terminal Token ABRE_VECTOR;
terminal Token CIERRA_VECTOR;
terminal Token BEGIN;
terminal Token END;
terminal Token FUNCTION;
terminal Token PROCEDURE;
terminal Token PROGRAM;
terminal Token IF;
terminal Token THEN;
terminal Token ELSE;
terminal Token REPEAT;
terminal Token UNTIL;
terminal Token TYPE;
terminal Token SET;
terminal Token CONST;
terminal Token VAR;
terminal Token BOOLEAN;
terminal Token INTEGER;
terminal Token TRUE;
terminal Token FALSE;
terminal Token IN;
terminal Token OF;
terminal Token OR;
terminal Token WRITE;
terminal Token NUMERO;
terminal Token CADENA;
terminal Token IDENTIFICADOR;


// Declaracion de no terminales
// no modificar los propuestos

non terminal  			program;
non terminal Axiom		axiom;
non terminal 			nada;
non terminal 			programa;
non terminal 			cabeceraPrograma;
non terminal 			cabeceraPrograma_1;
non terminal 			cabeceraPrograma_2;
non terminal 			cabeceraPrograma_3;
non terminal 			seccionDeclaracionConstantes;
non terminal 			declaracionConstantes;
non terminal 			declaracionConstante;
non terminal 			valorConstante;
non terminal 			seccionDeclaracionTipos;
non terminal 			declaracionTipos;
non terminal 			declaracionTipo;
non terminal 			valorTipo;
non terminal 			seccionDeclaracionVariables;
non terminal 			declaracionVariables;
non terminal 			declaracionVariable;
non terminal 			idsVariables;
non terminal 			tipoVariable;
non terminal 			declaracionSubprogramas;
non terminal 			declaracionSubprograma;
non terminal 			declaracionProcedimiento;
non terminal 			declaracionFuncion;
non terminal 			tipoFuncion;
non terminal 			parametros;
non terminal 			parametrosConTipo;
non terminal 			idsParametros;
non terminal 			tipoParametro;
non terminal 			cuerpoPrograma;
non terminal 			sentencias;
non terminal 			sentencia;
non terminal 			parametroWrite;
non terminal 			sentenciaIf;
non terminal 			referencia;
non terminal 			expresion;
non terminal 			sentenciaOBloque;
non terminal 			vector;
non terminal 			llamadaFuncion;
non terminal 			parametrosLlamadaFuncion;


// Declaracion de relaciones de precedencia

precedence nonassoc	MAYOR, DISTINTO;
precedence left     MAS, MENOS;
precedence left     POR;
precedence nonassoc	IN;
precedence left		OR;
precedence left		ABRE_VECTOR, CIERRA_VECTOR;
precedence left		ABRE_PARENTESIS, CIERRA_PARENTESIS;
precedence nonassoc ELSE;

// Declaraciï¿½n de reglas de produccion


start with program;

program ::= 
  {: 
        syntaxErrorManager.syntaxInfo ("Starting parsing..."); 
   :}
  axiom:ax
  {:   		
  		
  		syntaxErrorManager.syntaxInfo ("Parsing process ended.");
   :};


nada ::= ;

axiom ::= programa;

programa ::= PROGRAM IDENTIFICADOR:i PUNTO_Y_COMA cabeceraPrograma BEGIN cuerpoPrograma END PUNTO 			{: syntaxErrorManager.syntaxInfo("programa ::= ... - " + i.getLexema()); :};

// Si usamos multiples producciones seguidas posiblemente vacias (x | nada) el compilador se queja. Mejor usar construcciones acomulativas (x | x y)
// cabeceraPrograma ::= seccionDeclaracionConstantes seccionDeclaracionTipos seccionDeclaracionVariables declaracionSubprogramas;

cabeceraPrograma ::= seccionDeclaracionConstantes cabeceraPrograma_1								{: syntaxErrorManager.syntaxInfo("cabeceraPrograma ::= seccionDeclaracionConstantes cabeceraPrograma_1"); :}
					| cabeceraPrograma_1															{: syntaxErrorManager.syntaxInfo("cabeceraPrograma ::= cabeceraPrograma_1"); :};

cabeceraPrograma_1 ::= seccionDeclaracionTipos cabeceraPrograma_2									{: syntaxErrorManager.syntaxInfo("cabeceraPrograma_1 ::= seccionDeclaracionTipos cabeceraPrograma_2"); :}
					| cabeceraPrograma_2															{: syntaxErrorManager.syntaxInfo("cabeceraPrograma_1 ::= cabeceraPrograma_2"); :};

cabeceraPrograma_2 ::= seccionDeclaracionVariables cabeceraPrograma_3								{: syntaxErrorManager.syntaxInfo("cabeceraPrograma_2 ::= seccionDeclaracionVariables cabeceraPrograma_3"); :}
					| cabeceraPrograma_3 															{: syntaxErrorManager.syntaxInfo("cabeceraPrograma_2 ::= cabeceraPrograma_3"); :};
						
cabeceraPrograma_3 ::= declaracionSubprogramas														{: syntaxErrorManager.syntaxInfo("cabeceraPrograma_3 ::= declaracionSubprogramas"); :}
					| nada				 															{: syntaxErrorManager.syntaxInfo("cabeceraPrograma_3 ::= nada"); :};

// Constantes 

seccionDeclaracionConstantes ::= CONST declaracionConstantes										{: syntaxErrorManager.syntaxInfo("seccionDeclaracionConstantes ::= CONST declaracionConstantes"); :};

declaracionConstantes ::= declaracionConstante 														{: syntaxErrorManager.syntaxInfo("declaracionConstantes ::= declaracionConstante"); :}
						| declaracionConstante declaracionConstantes								{: syntaxErrorManager.syntaxInfo("declaracionConstantes ::= declaracionConstante declaracionConstantes"); :};

declaracionConstante ::= IDENTIFICADOR:i IGUAL valorConstante PUNTO_Y_COMA							{: syntaxErrorManager.syntaxInfo("declaracionConstante ::= IDENTIFICADOR IGUAL valorConstante PUNTO_Y_COMA - " + i.getLexema()); :}; 

valorConstante ::= NUMERO:n																			{: syntaxErrorManager.syntaxInfo("valorConstante ::= NUMERO - " + n.getLexema()); :}
				| TRUE 																				{: syntaxErrorManager.syntaxInfo("valorConstante ::= TRUE"); :}
				| FALSE																				{: syntaxErrorManager.syntaxInfo("valorConstante ::= FALSE"); :};

// Tipos

seccionDeclaracionTipos ::= TYPE declaracionTipos													{: syntaxErrorManager.syntaxInfo("seccionDeclaracionTipos ::= TYPE declaracionTipos"); :};

declaracionTipos ::= declaracionTipo 																{: syntaxErrorManager.syntaxInfo("declaracionTipos ::= declaracionTipo"); :}
					| declaracionTipo declaracionTipos												{: syntaxErrorManager.syntaxInfo("declaracionTipos ::= declaracionTipo declaracionTipos"); :};

declaracionTipo ::= IDENTIFICADOR:i IGUAL valorTipo PUNTO_Y_COMA									{: syntaxErrorManager.syntaxInfo("declaracionTipo ::= IDENTIFICADOR IGUAL valorTipo PUNTO_Y_COMA - " + i.getLexema()); :}; 

valorTipo ::= SET OF NUMERO:n1 RANGO NUMERO:n2														{: syntaxErrorManager.syntaxInfo("valorTipo ::= SET OF NUMERO RANGO NUMERO - " + n1.getLexema() + " - " + n2.getLexema()); :};

// Variables

seccionDeclaracionVariables ::= VAR declaracionVariables											{: syntaxErrorManager.syntaxInfo("seccionDeclaracionVariables ::= VAR declaracionVariables"); :};

declaracionVariables ::= declaracionVariable 														{: syntaxErrorManager.syntaxInfo("declaracionVariables ::= declaracionVariable"); :}
						| declaracionVariable declaracionVariables									{: syntaxErrorManager.syntaxInfo("declaracionVariables ::= declaracionVariable declaracionVariables"); :};

declaracionVariable ::= idsVariables DOS_PUNTOS tipoVariable PUNTO_Y_COMA							{: syntaxErrorManager.syntaxInfo("declaracionVariable ::= idsVariables DOS_PUNTOS tipoVariable PUNTO_Y_COMA"); :}; 

idsVariables ::= IDENTIFICADOR:i																	{: syntaxErrorManager.syntaxInfo("idsVariables ::= IDENTIFICADOR - " + i.getLexema()); :}
				| IDENTIFICADOR:i COMA idsVariables													{: syntaxErrorManager.syntaxInfo("idsVariables ::= IDENTIFICADOR COMA idsVariables - " + i.getLexema()); :};
				
tipoVariable ::= IDENTIFICADOR:i																	{: syntaxErrorManager.syntaxInfo("tipoVariable ::= IDENTIFICADOR - " + i.getLexema()); :}
				| INTEGER																			{: syntaxErrorManager.syntaxInfo("tipoVariable ::= INTEGER"); :}
				| BOOLEAN																			{: syntaxErrorManager.syntaxInfo("tipoVariable ::= BOOLEAN"); :};

// Subprogramas

declaracionSubprogramas ::= declaracionSubprograma													{: syntaxErrorManager.syntaxInfo("declaracionSubprogramas ::= declaracionSubprograma"); :}
							| declaracionSubprograma declaracionSubprogramas						{: syntaxErrorManager.syntaxInfo("declaracionSubprogramas ::= declaracionSubprograma declaracionSubprogramas"); :};

declaracionSubprograma ::= declaracionProcedimiento													{: syntaxErrorManager.syntaxInfo("declaracionSubprograma ::= declaracionProcedimiento"); :}
						| declaracionFuncion														{: syntaxErrorManager.syntaxInfo("declaracionSubprograma ::= declaracionFuncion"); :};

declaracionProcedimiento ::= PROCEDURE IDENTIFICADOR:i ABRE_PARENTESIS parametros CIERRA_PARENTESIS PUNTO_Y_COMA
							 cabeceraPrograma BEGIN cuerpoPrograma END PUNTO_Y_COMA					{: syntaxErrorManager.syntaxInfo("declaracionProcedimiento ::= ... - " + i.getLexema()); :};

declaracionFuncion ::= FUNCTION IDENTIFICADOR:i ABRE_PARENTESIS parametros CIERRA_PARENTESIS DOS_PUNTOS tipoFuncion PUNTO_Y_COMA
					   cabeceraPrograma BEGIN cuerpoPrograma END PUNTO_Y_COMA						{: syntaxErrorManager.syntaxInfo("declaracionFuncion ::= ... - " + i.getLexema()); :};

tipoFuncion ::= INTEGER																				{: syntaxErrorManager.syntaxInfo("tipoFuncion ::= INTEGER"); :}
				| BOOLEAN																			{: syntaxErrorManager.syntaxInfo("tipoFuncion ::= BOOLEAN"); :};
				
parametros ::= parametrosConTipo																	{: syntaxErrorManager.syntaxInfo("parametros ::= parametrosConTipo"); :}
				| parametrosConTipo PUNTO_Y_COMA parametros											{: syntaxErrorManager.syntaxInfo("parametros ::= parametrosConTipo PUNTO_Y_COMA parametros"); :};
				
parametrosConTipo ::= idsParametros DOS_PUNTOS tipoParametro 										{: syntaxErrorManager.syntaxInfo("parametrosConTipo ::= idsParametros DOS_PUNTOS tipoParametro"); :};

idsParametros ::= IDENTIFICADOR:i																	{: syntaxErrorManager.syntaxInfo("idsParametros ::= IDENTIFICADOR - " + i.getLexema()); :}
				| IDENTIFICADOR:i COMA idsVariables													{: syntaxErrorManager.syntaxInfo("idsParametros ::= IDENTIFICADOR COMA idsVariables - " + i.getLexema()); :};
				
tipoParametro ::= IDENTIFICADOR:i	 																{: syntaxErrorManager.syntaxInfo("tipoParametro ::= IDENTIFICADOR - " + i.getLexema()); :}
				| INTEGER			 																{: syntaxErrorManager.syntaxInfo("tipoParametro ::= INTEGER"); :}
				| BOOLEAN			 																{: syntaxErrorManager.syntaxInfo("tipoParametro ::= BOOLEAN"); :};

// Cuerpo

cuerpoPrograma ::= sentencias 																		{: syntaxErrorManager.syntaxInfo("cuerpoPrograma ::= sentencias"); :};

sentencias ::= nada																					{: syntaxErrorManager.syntaxInfo("sentencias ::= nada"); :}
			| sentencia sentencias																	{: syntaxErrorManager.syntaxInfo("sentencias ::= sentencia sentencias"); :};
			
sentencia ::= WRITE ABRE_PARENTESIS parametroWrite CIERRA_PARENTESIS PUNTO_Y_COMA					{: syntaxErrorManager.syntaxInfo("sentencia ::= WRITE ABRE_PARENTESIS parametroWrite CIERRA_PARENTESIS PUNTO_Y_COMA"); :}
			| referencia ASIGNACION expresion PUNTO_Y_COMA											{: syntaxErrorManager.syntaxInfo("sentencia ::= referencia ASIGNACION expresion PUNTO_Y_COMA"); :}
			| REPEAT sentencias UNTIL ABRE_PARENTESIS expresion CIERRA_PARENTESIS PUNTO_Y_COMA		{: syntaxErrorManager.syntaxInfo("sentencia ::= REPEAT sentencias UNTIL ABRE_PARENTESIS expresion CIERRA_PARENTESIS PUNTO_Y_COMA"); :}
			| sentenciaIf																			{: syntaxErrorManager.syntaxInfo("sentencia ::= sentenciaIf"); :}
			| llamadaFuncion PUNTO_Y_COMA 															{: syntaxErrorManager.syntaxInfo("sentencia ::= llamadaFuncion PUNTO_Y_COMA"); :};

parametroWrite ::= CADENA:c 																		{: syntaxErrorManager.syntaxInfo("parametroWrite ::= CADENA - " + c.getLexema()); :}
				| expresion																			{: syntaxErrorManager.syntaxInfo("parametroWrite ::= expresion"); :};

sentenciaIf ::= IF ABRE_PARENTESIS expresion CIERRA_PARENTESIS THEN sentenciaOBloque ELSE sentenciaOBloque 			{: syntaxErrorManager.syntaxInfo("sentenciaIf ::= IF ABRE_PARENTESIS expresion CIERRA_PARENTESIS THEN sentenciaOBloque ELSE sentenciaOBloque"); :}
			| IF ABRE_PARENTESIS expresion CIERRA_PARENTESIS THEN sentenciaOBloque									{: syntaxErrorManager.syntaxInfo("sentenciaIf ::= IF ABRE_PARENTESIS expresion CIERRA_PARENTESIS THEN sentenciaOBloque"); :};

referencia ::= IDENTIFICADOR:i ABRE_VECTOR expresion CIERRA_VECTOR									{: syntaxErrorManager.syntaxInfo("referencia ::= IDENTIFICADOR ABRE_VECTOR expresion CIERRA_VECTOR - " + i.getLexema()); :}
			| IDENTIFICADOR:i																		{: syntaxErrorManager.syntaxInfo("referencia ::= IDENTIFICADOR - " + i.getLexema()); :};
					
expresion ::= referencia																			{: syntaxErrorManager.syntaxInfo("expresion ::= referencia"); :}
			| NUMERO:n																				{: syntaxErrorManager.syntaxInfo("expresion ::= NUMERO - " + n.getLexema()); :}
			| TRUE																					{: syntaxErrorManager.syntaxInfo("expresion ::= TRUE"); :}
			| FALSE																					{: syntaxErrorManager.syntaxInfo("expresion ::= FALSE"); :}
			| ABRE_PARENTESIS expresion CIERRA_PARENTESIS 											{: syntaxErrorManager.syntaxInfo("expresion ::= ABRE_PARENTESIS expresion CIERRA_PARENTESIS"); :}
			| expresion MAS expresion																{: syntaxErrorManager.syntaxInfo("expresion ::= expresion MAS expresion"); :}
			| expresion MENOS expresion																{: syntaxErrorManager.syntaxInfo("expresion ::= expresion MENOS expresion"); :}
			| expresion POR expresion																{: syntaxErrorManager.syntaxInfo("expresion ::= expresion POR expresion"); :}
			| expresion MAYOR expresion																{: syntaxErrorManager.syntaxInfo("expresion ::= expresion MAYOR expresion"); :}
			| expresion DISTINTO expresion															{: syntaxErrorManager.syntaxInfo("expresion ::= expresion DISTINTO expresion"); :}
			| expresion IN expresion																{: syntaxErrorManager.syntaxInfo("expresion ::= expresion IN expresion"); :}
			| expresion OR expresion																{: syntaxErrorManager.syntaxInfo("expresion ::= expresion OR expresion"); :}
			| vector																				{: syntaxErrorManager.syntaxInfo("expresion ::= vector"); :}
			| llamadaFuncion																		{: syntaxErrorManager.syntaxInfo("expresion ::= llamadaFuncion"); :};		

sentenciaOBloque ::= sentencia																		{: syntaxErrorManager.syntaxInfo("sentenciaOBloque ::= sentencia"); :}
					| BEGIN sentencias END PUNTO_Y_COMA												{: syntaxErrorManager.syntaxInfo("sentenciaOBloque ::= BEGIN sentencias END PUNTO_Y_COMA"); :};
					
vector ::= ABRE_VECTOR CIERRA_VECTOR																{: syntaxErrorManager.syntaxInfo("vector ::= ABRE_VECTOR CIERRA_VECTOR"); :}
		| ABRE_VECTOR expresion RANGO expresion CIERRA_VECTOR										{: syntaxErrorManager.syntaxInfo("vector ::= ABRE_VECTOR expresion RANGO expresion CIERRA_VECTOR"); :};
					
llamadaFuncion ::= IDENTIFICADOR:i ABRE_PARENTESIS CIERRA_PARENTESIS								{: syntaxErrorManager.syntaxInfo("llamadaFuncion ::= IDENTIFICADOR ABRE_PARENTESIS CIERRA_PARENTESIS - " + i.getLexema()); :}
				| IDENTIFICADOR:i ABRE_PARENTESIS parametrosLlamadaFuncion CIERRA_PARENTESIS		{: syntaxErrorManager.syntaxInfo("llamadaFuncion ::= IDENTIFICADOR ABRE_PARENTESIS parametrosLlamadaFuncion CIERRA_PARENTESIS - " + i.getLexema()); :};
					
parametrosLlamadaFuncion ::= expresion 																{: syntaxErrorManager.syntaxInfo("parametrosLlamadaFuncion ::= expresion"); :}
							| expresion COMA parametrosLlamadaFuncion								{: syntaxErrorManager.syntaxInfo("parametrosLlamadaFuncion ::= expresion COMA parametrosLlamadaFuncion"); :};



					
					
					
					
					
					
					
					
					
					

